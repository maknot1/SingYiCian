{% extends "content/internal/base_internal.html" %}

{% block title %}Закладки{% endblock %}

{% block content %}

<div class="page-main page-main-inner bookmarks-page">

  <main class="main-center">

    <h1 class="bookmarks-title">Мои закладки</h1>

    <div class="bookmarks-grid">
      {% for item in page_obj %}
        <article class="post-card" data-slug="{{ item.post.slug }}">
          <a href="{% url 'post_detail' item.post.slug %}">
            <div class="post-card-body">
              <h3>{{ item.post.title }}</h3>
            </div>
          </a>

          <button class="bookmark-remove action-btn" type="button" data-slug="{{ item.post.slug }}">
            ⭐ Убрать
          </button>
        </article>
      {% empty %}
        <p>Закладок пока нет.</p>
      {% endfor %}
    </div>

    {% if page_obj and page_obj.has_other_pages %}
    <nav class="pagination">

      {% if page_obj.has_previous %}
        <a class="page-nav"
           href="?page={{ page_obj.previous_page_number }}">
          ←
        </a>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if num == page_obj.number %}
          <span class="page-number active">{{ num }}</span>
        {% elif num > page_obj.number|add:"-3" and num < page_obj.number|add:"3" %}
          <a class="page-number"
             href="?page={{ num }}">
            {{ num }}
          </a>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <a class="page-nav"
           href="?page={{ page_obj.next_page_number }}">
          →
        </a>
      {% endif %}

    </nav>
    {% endif %}

  </main>

</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".bookmark-remove").forEach(btn => {
    btn.addEventListener("click", async () => {
      const slug = btn.dataset.slug;

      const res = await fetch(`/bookmark/${slug}/toggle/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "X-Requested-With": "XMLHttpRequest"
        }
      });

      if (!res.ok) return;

      const data = await res.json();

      if (data.state === "removed") {
        const card = btn.closest(".post-card");
        if (card) card.remove();
      }
    });
  });
});
</script>
{% endblock %}