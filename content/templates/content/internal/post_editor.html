{% extends "content/internal/base_internal.html" %}

{% block title %}
  {% if mode == "create" %}–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è{% else %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏{% endif %}
{% endblock %}

{% block content %}

<h1>
  {% if mode == "create" %}–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è{% else %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏{% endif %}
</h1>

<form method="post"
      enctype="multipart/form-data"
      class="post-editor-form"
      id="post-editor-form">

  {% csrf_token %}


<!-- ================= CATALOG PICKER ================= -->
<div class="form-row">
  <label>–ö–∞—Ç–∞–ª–æ–≥</label>

  <select id="catalog-picker" class="catalog-picker">
    <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–∞–ª–æ–≥ ‚Äî</option>
    <option value="sinyi">–°–∏–Ω—å –ò –¶—é–∞–Ω—å</option>
    <option value="taiji">–¢–∞–π—Ü–∑–∏</option>
  </select>
</div>

  <!-- ================= SECTION PICKER ================= -->
  <div class="form-row">
    <label>–†–∞–∑–¥–µ–ª</label>

    <div class="section-picker">
      <span id="section-picker-label"
            class="section-picker-label muted">
        –†–∞–∑–¥–µ–ª –Ω–µ –≤—ã–±—Ä–∞–Ω
      </span>

      <button type="button"
              id="section-picker-btn"
              class="btn btn-secondary">
        –í—ã–±—Ä–∞—Ç—å
      </button>
    </div>
<!-- ================= SECTION TREE MODAL (–í–ù–ï FORM!) ================= -->
<div id="section-tree-modal" class="modal hidden">
  <div class="modal-overlay"></div>

  <div class="modal-window">
    <div class="modal-header">
      <h3>–í—ã–±–æ—Ä —Ä–∞–∑–¥–µ–ª–∞</h3>
    </div>

    <div class="modal-body">
      <input type="search"
             id="section-tree-search"
             placeholder="–ü–æ–∏—Å–∫ —Ä–∞–∑–¥–µ–ª–∞‚Ä¶">

      <div id="section-tree" class="section-tree"></div>
    </div>

    <div class="modal-footer">
      <button type="button"
              class="btn btn-secondary"
              id="section-tree-cancel">
        –û—Ç–º–µ–Ω–∞
      </button>
    </div>
  </div>
</div>

    <!-- –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π input, –∫–æ—Ç–æ—Ä—ã–π —É–π–¥—ë—Ç –≤ POST -->
    <input type="hidden" name="section" id="section-input">
  </div>

  <!-- ================= TITLE ================= -->
  <div class="form-row">
    <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
    {{ form.title }}
  </div>

  <!-- ================= CONTENT ================= -->
  <div class="form-row">
    <label>–¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏</label>

    <div class="editor-toolbar" id="editor-toolbar">
      <button type="button" class="ql-bold"></button>
      <select class="ql-color"></select>
      <button type="button" id="btn-uppercase">Aa</button>
      <button type="button" class="ql-image"></button>

      <button type="button" id="img-plus-10">+10</button>
      <button type="button" id="img-minus-10">‚àí10</button>
      <button type="button" id="img-plus-50">+50</button>
      <button type="button" id="img-minus-50">‚àí50</button>

      <button type="button" id="btn-caption">üìù</button>
      <button type="button" id="btn-delete-image">üóë</button>
    </div>

    <div id="editor" class="rich-editor"></div>
    <input type="hidden" name="content" id="content-input">
  </div>


  <!-- ================= STATUS ================= -->
  <div class="form-row">
    <label>–°—Ç–∞—Ç—É—Å</label>
    {{ form.status }}
  </div>
<!-- ================= FEATURED ================= -->
<div class="form-row form-featured">

  <label class="featured-label">
    {{ form.is_featured }}
    <span class="featured-title">
      üìå –ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å—Ç–∞—Ç—å—é –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –∫–∞—Ç–∞–ª–æ–≥–µ
    </span>
  </label>

  <div class="featured-hint">
    –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Ü–µ–Ω—Ç—Ä–µ –∫–∞—Ç–∞–ª–æ–≥–∞
    –∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.
  </div>

</div>




  <!-- ================= NOTE ================= -->
  <div class="form-row">
    <label>–ó–∞–º–µ—Ç–∫–∞ –∫ –≤–µ—Ä—Å–∏–∏</label>
    {{ form.note }}
  </div>

  <!-- ================= ACTIONS ================= -->
  <div class="form-actions">
    <button type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

    {% if post %}
      <a href="{% url 'post_detail' post.slug %}">
        ‚Üê –ù–∞–∑–∞–¥ –∫ —Å—Ç–∞—Ç—å–µ
      </a>
    {% else %}
      <a href="{% url 'dashboard' %}">
        ‚Üê –ù–∞–∑–∞–¥ –≤ –ø–∞–Ω–µ–ª—å
      </a>
    {% endif %}
  </div>

</form>


<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>



<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<script>
const DRAFT_KEY = "post_editor_draft_create";

document.addEventListener("DOMContentLoaded", () => {

  const sectionInput  = document.getElementById("section-input");
  const sectionLabel  = document.getElementById("section-picker-label");
  const catalogPicker = document.getElementById("catalog-picker");

  let currentCatalog = ""; // ‚≠ê NEW

  // ==================================================
  // HELPERS
  // ==================================================
  function getCSRFToken() {
    const el = document.querySelector('[name=csrfmiddlewaretoken]');
    return el ? el.value : "";
  }

  // ==================================================
  // QUILL INIT
  // ==================================================
  const quill = new Quill("#editor", {
    theme: "snow",
    modules: {
      toolbar: {
        container: "#editor-toolbar",
        handlers: { image: uploadImage }
      }
    }
  });

  // ==================================================
  // LOAD EXISTING CONTENT
  // ==================================================
  const initialHtml = `{% if post and post.current_revision %}{{ post.current_revision.content|escapejs }}{% endif %}`;
  if (initialHtml) quill.clipboard.dangerouslyPasteHTML(initialHtml);

  // ==================================================
  // INIT FROM EXISTING POST
  // ==================================================
  {% if post and post.section %}
    sectionInput.value = "{{ post.section.id }}";
    sectionLabel.textContent = "{{ post.section.title|escapejs }}";
    sectionLabel.classList.remove("muted");

    currentCatalog = "{{ post.section.catalog }}";
    if (catalogPicker) {
      catalogPicker.value = currentCatalog;
    }
  {% endif %}

  // ==================================================
  // ‚≠ê NEW: CATALOG CHANGE HANDLER
  // ==================================================
  if (catalogPicker) {
    catalogPicker.addEventListener("change", () => {
      currentCatalog = catalogPicker.value;

      // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∞–∑–¥–µ–ª
      sectionInput.value = "";
      sectionLabel.textContent = "–†–∞–∑–¥–µ–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
      sectionLabel.classList.add("muted");
    });
  }
  // ==================================================
  // FEATURED TOGGLE (–ú–ò–ù–ò–ú–ê–õ–¨–ù–û –ò –†–ê–ë–û–ß–ï)
  // ==================================================
  const featuredCheckbox = document.querySelector('[name="is_featured"]');

  function updateFeaturedState() {
    if (!featuredCheckbox) return;

    if (!currentCatalog) {
      featuredCheckbox.checked = false;
      featuredCheckbox.disabled = true;
    } else {
      featuredCheckbox.disabled = false;
    }
  }

  // –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  updateFeaturedState();

  // –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–∞—Ç–∞–ª–æ–≥–∞
  if (catalogPicker) {
    catalogPicker.addEventListener("change", () => {
      updateFeaturedState();
    });
  }

  // ==================================================
  // IMAGE UPLOAD
  // ==================================================
  function uploadImage() {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.click();

    input.onchange = async () => {
      const file = input.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("image", file);

      const res = await fetch("{% url 'upload_editor_image' %}", {
        method: "POST",
        headers: { "X-CSRFToken": getCSRFToken() },
        body: formData
      });

      const data = await res.json();
      if (!data.url) return;

      const range = quill.getSelection() || { index: quill.getLength(), length: 0 };
      quill.insertEmbed(range.index, "image", data.url);
      quill.insertText(range.index + 1, "\n");
      quill.setSelection(range.index + 2, 0);
    };
  }

  // ==================================================
  // IMAGE SELECTION FIX
  // ==================================================
  let lastImageIndex = null;

  quill.root.addEventListener("click", (e) => {
    if (e.target.tagName !== "IMG") return;
    const blot = Quill.find(e.target);
    if (!blot) return;

    lastImageIndex = quill.getIndex(blot);
    quill.setSelection(lastImageIndex + 1, 0, "silent");
  });

  function getSelectedImage() {
    if (lastImageIndex === null) return null;
    const [leaf] = quill.getLeaf(lastImageIndex);
    if (!leaf || leaf.domNode.tagName !== "IMG") return null;
    return { img: leaf.domNode, index: lastImageIndex };
  }

  function resizeImage(delta) {
    const picked = getSelectedImage();
    if (!picked) return alert("–°–Ω–∞—á–∞–ª–∞ –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é");

    const img = picked.img;
    const current =
      img.getAttribute("width")
        ? parseInt(img.getAttribute("width"), 10)
        : img.getBoundingClientRect().width;

    const next = Math.max(80, current + delta);

    img.setAttribute("width", next);
    img.style.width = next + "px";
    img.style.maxWidth = "100%";
    img.style.height = "auto";
  }

  document.getElementById("img-plus-10").onclick  = () => resizeImage(+10);
  document.getElementById("img-minus-10").onclick = () => resizeImage(-10);
  document.getElementById("img-plus-50").onclick  = () => resizeImage(+50);
  document.getElementById("img-minus-50").onclick = () => resizeImage(-50);

  document.getElementById("btn-caption").onclick = () => {
    const picked = getSelectedImage();
    if (!picked) return alert("–°–Ω–∞—á–∞–ª–∞ –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é");

    const insertAt = picked.index + 1;
    quill.insertText(insertAt, "\n–ü–æ–¥–ø–∏—Å—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é\n", { italic: true });

    const [line] = quill.getLine(insertAt + 1);
    if (line?.domNode) line.domNode.classList.add("img-caption");

    quill.setSelection(insertAt + 2, 0);
  };

  document.getElementById("btn-delete-image").onclick = () => {
    const picked = getSelectedImage();
    if (!picked) return alert("–°–Ω–∞—á–∞–ª–∞ –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é");

    quill.deleteText(picked.index, 1);
    lastImageIndex = null;
  };

  // ==================================================
  // UPPERCASE
  // ==================================================
  let lastRange = null;
  quill.on("selection-change", (range) => { if (range) lastRange = range; });

  document.getElementById("btn-uppercase").addEventListener("mousedown", (e) => {
    e.preventDefault();
    const range = quill.getSelection() || lastRange;
    if (!range || range.length === 0) return;

    const text = quill.getText(range.index, range.length);
    quill.deleteText(range.index, range.length);
    quill.insertText(range.index, text.toUpperCase());
    quill.setSelection(range.index, text.length);
  });

  // ==================================================
  // AUTOSAVE DRAFT
  // ==================================================
  let isDirty = false;

  setInterval(() => {
    const html = quill.root.innerHTML.trim();
    if (!html || html === "<p><br></p>") return;

    const draft = {
      title: document.querySelector('[name="title"]')?.value || "",
      section: sectionInput.value || "",
      sectionLabel: sectionLabel.textContent || "",
      content: html,
      savedAt: Date.now()
    };

    localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
    isDirty = true;
  }, 3000);

  window.addEventListener("beforeunload", (e) => {
    if (!isDirty) return;
    e.preventDefault();
    e.returnValue = "";
  });

  // ==================================================
  // SUBMIT
  // ==================================================
  document.getElementById("post-editor-form").addEventListener("submit", (e) => {
    const html = quill.root.innerHTML.trim();
    if (!html || html === "<p><br></p>") {
      e.preventDefault();
      alert("–¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏ –ø—É—Å—Ç–æ–π");
      return;
    }

    document.getElementById("content-input").value = html;
    localStorage.removeItem(DRAFT_KEY);
    isDirty = false;
  });

  // ==================================================
  // SECTION PICKER (WITH CATALOG FILTER)
  // ==================================================
  const pickerBtn = document.getElementById("section-picker-btn");
  const modal   = document.getElementById("section-tree-modal");
  const treeEl  = document.getElementById("section-tree");
  const cancel  = document.getElementById("section-tree-cancel");

  if (pickerBtn && modal && treeEl && cancel) {

    let currentPage = 1;
    let totalPages  = 1;

    pickerBtn.addEventListener("click", () => {
      if (!currentCatalog) {
        alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–∞–ª–æ–≥");
        return;
      }
      modal.classList.remove("hidden");
      loadPage(1);
    });

    cancel.addEventListener("click", () => {
      modal.classList.add("hidden");
    });

    async function loadPage(page) {
      treeEl.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

      const res = await fetch(
        `/api/sections/tree/?page=${page}&catalog=${currentCatalog}`
      );

      const data = await res.json();
      currentPage = data.current;
      totalPages  = data.pages;

      renderTree(data.data);
      renderPagination();
    }

    function renderTree(roots) {
      treeEl.innerHTML = "";
      roots.forEach(root => appendNode(root, 0));
    }

    function appendNode(node, depth) {
      const el = document.createElement("div");
      el.className = "section-node";
      el.style.marginLeft = `${depth * 16}px`;
      el.textContent = node.title;

      if (depth !== 2) {
        el.classList.add("disabled");
      } else {
        el.addEventListener("click", () => {
          sectionInput.value = node.id;
          sectionLabel.textContent = node.title;
          sectionLabel.classList.remove("muted");
          modal.classList.add("hidden");
        });
      }

      treeEl.appendChild(el);

      if (node.children?.length) {
        node.children.forEach(child => appendNode(child, depth + 1));
      }
    }

    function renderPagination() {
      const nav = document.createElement("div");
      nav.className = "section-pagination";

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = i;
        if (i === currentPage) btn.classList.add("active");
        btn.addEventListener("click", () => loadPage(i));
        nav.appendChild(btn);
      }

      treeEl.appendChild(nav);
    }

  }

});
</script>



{% endblock %}
