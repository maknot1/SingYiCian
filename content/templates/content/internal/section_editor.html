{% extends "content/internal/base_internal.html" %}

{% block title %}
  {% if mode == "edit" %}
    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞
  {% else %}
    –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞
  {% endif %}
{% endblock %}

{% block content %}

<div class="dashboard-header">
  <h1>
    {% if mode == "edit" %}
      ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞
    {% else %}
      ‚ûï –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞
    {% endif %}
  </h1>

  <div class="dashboard-actions">
    <a href="{% url 'section_list' %}" class="btn btn-secondary">
      ‚Üê –ö —Å–ø–∏—Å–∫—É —Ä–∞–∑–¥–µ–ª–æ–≤
    </a>
  </div>
</div>

<div class="dashboard-card">

  {% if error %}
    <div class="form-errors">
      ‚ö† {{ error }}
    </div>
  {% endif %}

  <form method="post" class="editor-form" id="section-editor-form">
    {% csrf_token %}

    <!-- ================= CATALOG ================= -->
    <div class="form-row">
      <label>–ö–∞—Ç–∞–ª–æ–≥</label>
      <select id="catalog-picker" name="catalog" required>
        <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–∞–ª–æ–≥ ‚Äî</option>
        <option value="sinyi">–°–∏–Ω—å –ò –¶—é–∞–Ω—å</option>
        <option value="taiji">–¢–∞–π—Ü–∑–∏</option>
      </select>
    </div>

    <!-- ================= PARENT PICKER ================= -->
    <div class="form-row">
      <label>–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —Ä–∞–∑–¥–µ–ª</label>

      <div class="section-picker">
        <span id="parent-label" class="muted">
          –ö–æ—Ä–Ω–µ–≤–æ–π —Ä–∞–∑–¥–µ–ª
        </span>

        <button type="button"
                id="parent-picker-btn"
                class="btn btn-secondary">
          –í—ã–±—Ä–∞—Ç—å
        </button>
      </div>

      <input type="hidden" name="parent" id="parent-input">

      <small class="muted">
        –ï—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω ‚Äî —Ä–∞–∑–¥–µ–ª –±—É–¥–µ—Ç –∫–æ—Ä–Ω–µ–≤—ã–º
      </small>
    </div>

    <!-- ================= TITLE ================= -->
    <div class="form-row">
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞</label>
      {{ form.title }}
    </div>

    <!-- ================= ACTIONS ================= -->
    <div class="form-actions">
      <button type="submit" class="btn btn-primary">
        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
      </button>

      <a href="{% url 'section_list' %}" class="btn btn-secondary">
        –û—Ç–º–µ–Ω–∞
      </a>
    </div>

  </form>

  {% if mode == "edit" %}
    <hr style="margin: 2rem 0; opacity: .3">

    <form method="post"
          action="{% url 'delete_section' section.slug %}"
          onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–¥–µ–ª? –í –Ω—ë–º –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å—Ç–∞—Ç–µ–π.');">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger">
        üóë –£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–¥–µ–ª
      </button>
    </form>
  {% endif %}

</div>

<!-- ================= SECTION TREE MODAL ================= -->
<div id="section-tree-modal" class="modal hidden">
  <div class="modal-overlay"></div>

  <div class="modal-window">
    <div class="modal-header">
      <h3>–í—ã–±–æ—Ä —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞</h3>
    </div>

    <div class="modal-body">
      <div id="section-tree" class="section-tree">
        –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶
      </div>
    </div>

    <div class="modal-footer">
      <button type="button"
              id="section-tree-cancel"
              class="btn btn-secondary">
        –û—Ç–º–µ–Ω–∞
      </button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const catalogPicker = document.getElementById("catalog-picker");
  const parentInput   = document.getElementById("parent-input");
  const parentLabel   = document.getElementById("parent-label");

  const modal   = document.getElementById("section-tree-modal");
  const treeEl  = document.getElementById("section-tree");
  const openBtn = document.getElementById("parent-picker-btn");
  const cancel  = document.getElementById("section-tree-cancel");

  let currentCatalog = "";
  let currentPage = 1;
  let totalPages  = 1;

  // ===== INIT FROM EDIT MODE =====
  {% if mode == "edit" and section %}
    catalogPicker.value = "{{ section.catalog }}";
    currentCatalog = "{{ section.catalog }}";

    {% if section.parent %}
      parentInput.value = "{{ section.parent.id }}";
      parentLabel.textContent = "{{ section.parent.title|escapejs }}";
      parentLabel.classList.remove("muted");
    {% endif %}
  {% endif %}

  // ===== CATALOG CHANGE =====
  catalogPicker.addEventListener("change", () => {
    currentCatalog = catalogPicker.value;
    parentInput.value = "";
    parentLabel.textContent = "–ö–æ—Ä–Ω–µ–≤–æ–π —Ä–∞–∑–¥–µ–ª";
    parentLabel.classList.add("muted");
  });

  // ===== OPEN MODAL =====
  openBtn.addEventListener("click", () => {
    if (!currentCatalog) {
      alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–∞–ª–æ–≥");
      return;
    }
    modal.classList.remove("hidden");
    loadPage(1);
  });

  cancel.addEventListener("click", () => {
    modal.classList.add("hidden");
  });

  // ===== LOAD PAGE =====
  async function loadPage(page) {
    treeEl.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

    const res = await fetch(
      `/api/sections/tree/?catalog=${currentCatalog}&page=${page}`
    );

    const data = await res.json();
    currentPage = data.current;
    totalPages  = data.pages;

    renderTree(data.data);
    renderPagination();
  }

  // ===== RENDER TREE =====
  function renderTree(roots) {
    treeEl.innerHTML = "";
    roots.forEach(root => renderNode(root, 0));
  }

  function renderNode(node, depth) {
    const el = document.createElement("div");
    el.className = "section-node";
    el.style.marginLeft = `${depth * 16}px`;
    el.textContent = node.title;

    if (depth >= 2) {
      el.classList.add("disabled");
    } else {
      el.addEventListener("click", () => {
        parentInput.value = node.id;
        parentLabel.textContent = node.title;
        parentLabel.classList.remove("muted");
        modal.classList.add("hidden");
      });
    }

    treeEl.appendChild(el);

    if (node.children && node.children.length) {
      node.children.forEach(child =>
        renderNode(child, depth + 1)
      );
    }
  }

  // ===== PAGINATION =====
  function renderPagination() {
    if (totalPages <= 1) return;

    const nav = document.createElement("div");
    nav.className = "section-pagination";

    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = i;
      if (i === currentPage) btn.classList.add("active");
      btn.addEventListener("click", () => loadPage(i));
      nav.appendChild(btn);
    }

    treeEl.appendChild(nav);
  }

});
</script>


{% endblock %}
