{% extends "content/internal/base_internal.html" %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<div class="article-wrapper">
  <article class="article-content">

    <header class="article-header">
      <h1>{{ post.title }}</h1>
    </header>

    <div class="article-body">
      {% if revision %}
        {{ revision.content|safe }}
      {% else %}
        <p>Контент пока не опубликован.</p>
      {% endif %}
    </div>

    <div class="article-actions">
      {% if post.section %}
        <a href="{% url 'section_detail' post.section.slug %}" class="action-btn back-btn">
          ← В раздел
        </a>
      {% endif %}

      <button id="bookmark-btn"
              class="action-btn"
              data-slug="{{ post.slug }}"
              data-state="{% if is_bookmarked %}added{% else %}removed{% endif %}">
        ⭐ <span class="bookmark-text">{% if is_bookmarked %}Убрать из закладок{% else %}В закладки{% endif %}</span>
      </button>

      {% if can_edit %}
        <a href="{% url 'edit_post' post.slug %}" class="action-btn edit-btn">
          Редактировать
        </a>
      {% endif %}
    </div>

  </article>
</div>
{% endblock %}


{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("bookmark-btn");
  if (!btn) return;

  function render(state){
    btn.dataset.state = state;
    btn.textContent = (state === "added")
      ? "⭐ Убрать из закладок"
      : "⭐ В закладки";
  }

  btn.addEventListener("click", async () => {
    const slug = btn.dataset.slug;

    const res = await fetch(`/bookmark/${slug}/toggle/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "X-Requested-With": "XMLHttpRequest"
      }
    });

    if (!res.ok) return;

    const data = await res.json();
    if (data.state === "added" || data.state === "removed"){
      render(data.state);
    }
  });
});
</script>
{% endblock %}